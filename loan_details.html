<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Ledger</title>
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Status Badge */
        .loan-status-badge {
            display: inline-block; padding: 0.4rem 1rem; font-weight: 600;
            border-radius: 20px; font-size: 0.9rem; color: white;
            margin-bottom: 1rem; text-align: center;
        }
        .status-Active { background-color: var(--success-color); }
        .status-Closed { background-color: var(--secondary-color); }

        /* Summary Grid Layout */
        .summary-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem;
        }
        .summary-item strong {
            display: block; font-size: 0.85rem; color: var(--text-light);
            text-transform: uppercase; margin-bottom: 0.25rem;
        }
        .summary-item span { font-size: 1.1rem; font-weight: 600; }

        /* Outstanding Grid */
        .outstanding-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: center;
        }
        .outstanding-item { background: var(--bg-color); padding: 1rem; border-radius: 8px; }
        .outstanding-item strong { display: block; color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.5rem; }
        .outstanding-item span { font-size: 1.3rem; font-weight: 700; }

        /* Total Due Box */
        .total-due {
            margin-top: 1rem; text-align: center; background: var(--secondary-color);
            color: white; padding: 1.5rem; border-radius: 8px;
        }
        .total-due span { display: block; font-size: 2.2rem; font-weight: 700; }

        /* Breakdown Table - Scrollable */
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 1rem; }
        .breakdown-table { width: 100%; min-width: 500px; border-collapse: collapse; }
        .breakdown-table th { text-align: left; color: var(--text-light); font-size: 0.85rem; padding: 8px; border-bottom: 1px solid var(--border-color); }
        .breakdown-table td { padding: 10px 8px; border-bottom: 1px solid #eee; font-size: 0.95rem; }
        .breakdown-table td:not(:first-child), .breakdown-table th:not(:first-child) { text-align: right; }

        /* Transaction List */
        .txn-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid #eee;
        }
        .txn-val { font-weight: 700; font-family: monospace; font-size: 1.1rem; }
        .val-int { color: var(--success-color); } /* Green for Interest */
        .val-prin { color: var(--secondary-color); } /* Red for Principal */

        /* Disabled State for Closed Loans */
        .loan-closed-overlay { opacity: 0.5; pointer-events: none; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <script src="utils.js"></script>
</head>
<body>

    <main class="container">
        <h1 style="margin-bottom: 0.5rem;">Loan Ledger</h1>
        <div style="text-align: center;">
            <div id="status-badge" class="loan-status-badge status-Active">Loading...</div>
        </div>

        <section class="card">
            <h2>Loan Summary</h2>
            <div class="summary-grid">
                <div class="summary-item"><strong>Customer</strong> <span id="s-name">...</span></div>
                <div class="summary-item"><strong>Phone</strong> <span id="s-phone">...</span></div>
                <div class="summary-item"><strong>Principal</strong> <span id="s-principal">...</span></div>
                <div class="summary-item"><strong>Interest Rate</strong> <span id="s-rate">...</span></div>
                <div class="summary-item"><strong>Start Date</strong> <span id="s-date">...</span></div>
                <div class="summary-item"><strong>Articles</strong> <span id="s-articles">...</span></div>
                <div class="summary-item"><strong>Gross Wt</strong> <span id="s-gross">...</span></div>
                <div class="summary-item"><strong>Net Wt</strong> <span id="s-net">...</span></div>
            </div>
        </section>

        <section class="card">
            <h2>Outstanding Balance</h2>
            <div class="outstanding-grid">
                <div class="outstanding-item">
                    <strong>Principal</strong>
                    <span id="out-prin" style="color: var(--primary-color);">...</span>
                </div>
                <div class="outstanding-item">
                    <strong>Interest</strong>
                    <span id="out-int" style="color: var(--secondary-color);">...</span>
                </div>
            </div>
            <div class="total-due">
                <strong>Total Amount Due</strong>
                <span id="out-total">...</span>
            </div>
            <p style="text-align: center; margin-top: 10px; font-size: 0.85rem; color: #888;" id="calc-date-label">...</p>
        </section>

        <section class="card">
            <h2>Interest Breakdown</h2>
            <div class="table-wrapper">
                <table class="breakdown-table">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Start Principal</th>
                            <th>Interest Accrued</th>
                        </tr>
                    </thead>
                    <tbody id="breakdown-body">
                        </tbody>
                </table>
            </div>
        </section>

        <section class="card" id="add-txn-card">
            <h2>Add Transaction</h2>
            <form id="txn-form">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="t-date" required>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="t-amount" step="0.01" placeholder="0.00" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="t-type">
                        <option value="Interest Payment">Interest Payment</option>
                        <option value="Principal Repayment">Principal Repayment</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <input type="text" id="t-note" placeholder="Optional note...">
                </div>
                <button type="submit" class="btn-primary" id="add-btn">Add Transaction</button>
            </form>
        </section>

        <section class="card">
            <h2>Transaction History</h2>
            <div id="txn-history-list">
                </div>
        </section>

        <section class="card" id="action-card">
            <h2>Actions</h2>
            <button id="close-loan-btn" class="btn-danger" style="width: 100%;">Close This Loan</button>
        </section>

    </main>

    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
            Dashboard
        </a>
        <a href="loan_list.html" class="nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
            Loans
        </a>
        <a href="customer_list.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            Customers
        </a>
        <a href="pj.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
            PJ List
        </a>
    </nav>
    <div id="toast-container"></div>

    <script>
        // --- 1. CONFIG & STATE ---
        const params = new URLSearchParams(window.location.search);
        const loanId = params.get('id');
        let g_loan = null;

        // --- 2. MAIN LOGIC ---
        async function loadData() {
            if (!loanId) {
                document.querySelector('.container').innerHTML = '<h2>Error: No Loan ID</h2>';
                return;
            }

            // Fetch Loan (with Customer) and Transactions
            const [lRes, tRes] = await Promise.all([
                sbClient.from('loans').select('*, customers(*)').eq('id', loanId).single(),
                sbClient.from('loan_transactions').select('*').eq('loan_id', loanId).order('txn_date', { ascending: true }) // Fetch Oldest First for Calculation
            ]);

            if (lRes.error) {
                showToast(lRes.error.message, 'error');
                return;
            }

            g_loan = lRes.data;
            const transactions = tRes.data || [];

            renderSummary(g_loan);
            
            // Perform Calculation (This logic is specific to this page to generate the breakdown table)
            const calcResult = calculateLedger(g_loan, transactions);
            
            renderBalance(calcResult);
            renderBreakdownTable(calcResult.breakdown);
            renderTransactionHistory(transactions);
            renderStatus(g_loan);
        }

        // --- 3. CALCULATION ENGINE (Supports Breakdown Table) ---
        function calculateLedger(loan, transactions) {
            const monthlyRate = (loan.interest_rate / 100) / 12;
            const startDate = new Date(loan.start_date);
            // End date is today, or the closed date if the loan is closed
            const endDate = loan.status === 'Closed' && loan.closed_date ? new Date(loan.closed_date) : new Date();
            
            let currentPrincipal = loan.principal_amount;
            let totalInterestAccrued = 0;
            let totalInterestPaid = 0;
            let totalPrincipalPaid = 0;
            
            let breakdown = [];
            let txnIndex = 0;
            
            // Start calculation from the 1st of the start month
            let calcDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);

            // Loop until we pass the end date
            while (calcDate <= endDate) {
                // 1. Calculate Interest for this month
                const interestForThisMonth = currentPrincipal * monthlyRate;
                totalInterestAccrued += interestForThisMonth;

                // 2. Add to breakdown list
                breakdown.push({
                    month: calcDate.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' }),
                    startPrincipal: currentPrincipal,
                    interest: interestForThisMonth
                });

                // 3. Move to next month
                const nextMonth = new Date(calcDate.getFullYear(), calcDate.getMonth() + 1, 1);

                // 4. Process transactions falling in this month
                while (txnIndex < transactions.length) {
                    const t = transactions[txnIndex];
                    const tDate = new Date(t.txn_date);
                    
                    if (tDate >= nextMonth) break; // Transaction is in future months

                    if (t.txn_type === 'Interest Payment') {
                        totalInterestPaid += t.amount;
                    } else if (t.txn_type === 'Principal Repayment') {
                        currentPrincipal -= t.amount;
                        totalPrincipalPaid += t.amount;
                    }
                    txnIndex++;
                }
                
                calcDate = nextMonth;
            }

            return {
                outstandingPrincipal: loan.principal_amount - totalPrincipalPaid,
                outstandingInterest: totalInterestAccrued - totalInterestPaid,
                totalDue: (loan.principal_amount - totalPrincipalPaid) + (totalInterestAccrued - totalInterestPaid),
                breakdown: breakdown
            };
        }

        // --- 4. RENDERERS ---
        function renderSummary(loan) {
            document.getElementById('s-name').textContent = loan.customers?.name || 'Unknown';
            document.getElementById('s-phone').textContent = loan.customers?.phone || 'N/A';
            document.getElementById('s-principal').textContent = currencyFormatter.format(loan.principal_amount);
            document.getElementById('s-rate').textContent = loan.interest_rate + '% p.a.';
            document.getElementById('s-date').textContent = dateFormatter(loan.start_date);
            document.getElementById('s-articles').textContent = loan.articles || '-';
            document.getElementById('s-gross').textContent = loan.gross ? loan.gross + ' g' : '-';
            document.getElementById('s-net').textContent = loan.net ? loan.net + ' g' : '-';
        }

        function renderBalance(res) {
            document.getElementById('out-prin').textContent = currencyFormatter.format(res.outstandingPrincipal);
            document.getElementById('out-int').textContent = currencyFormatter.format(res.outstandingInterest);
            document.getElementById('out-total').textContent = currencyFormatter.format(res.totalDue);
            document.getElementById('calc-date-label').textContent = `Calculated as of ${dateFormatter(new Date().toISOString())}`;
        }

        function renderBreakdownTable(list) {
            const tbody = document.getElementById('breakdown-body');
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No interest accrued yet.</td></tr>';
                return;
            }
            tbody.innerHTML = list.map(row => `
                <tr>
                    <td>${row.month}</td>
                    <td>${currencyFormatter.format(row.startPrincipal)}</td>
                    <td style="color: var(--success-color); font-weight:600;">+${currencyFormatter.format(row.interest)}</td>
                </tr>
            `).join('');
        }

        function renderTransactionHistory(list) {
            // Sort by Date Descending for display (Newest on top)
            const displayList = [...list].sort((a, b) => new Date(b.txn_date) - new Date(a.txn_date));
            const container = document.getElementById('txn-history-list');
            
            if (displayList.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999;">No transactions yet.</p>';
                return;
            }

            container.innerHTML = displayList.map(t => {
                const isInt = t.txn_type === 'Interest Payment';
                return `
                <div class="txn-item">
                    <div>
                        <div style="font-weight:600;">${dateFormatter(t.txn_date)}</div>
                        <div style="font-size:0.85rem; color:#666;">
                            ${t.txn_type} ${t.note ? ' - ' + t.note : ''}
                        </div>
                    </div>
                    <div class="txn-val ${isInt ? 'val-int' : 'val-prin'}">
                        -${currencyFormatter.format(t.amount)}
                    </div>
                </div>`;
            }).join('');
        }

        function renderStatus(loan) {
            const badge = document.getElementById('status-badge');
            badge.textContent = loan.status;
            badge.className = `loan-status-badge status-${loan.status}`;

            // If Closed, disable inputs
            if (loan.status === 'Closed') {
                document.getElementById('add-txn-card').classList.add('loan-closed-overlay');
                document.getElementById('add-btn').disabled = true;
                document.getElementById('add-btn').textContent = 'Loan Closed';
                
                document.getElementById('action-card').classList.add('loan-closed-overlay');
                document.getElementById('close-loan-btn').disabled = true;
            }
        }

        // --- 5. EVENT HANDLERS ---
        
        // Add Transaction
        document.getElementById('txn-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('add-btn');
            btn.textContent = 'Saving...'; btn.disabled = true;

            const { error } = await sbClient.from('loan_transactions').insert({
                loan_id: loanId,
                txn_date: document.getElementById('t-date').value,
                amount: document.getElementById('t-amount').value,
                txn_type: document.getElementById('t-type').value,
                note: document.getElementById('t-note').value
            });

            if (error) {
                showToast(error.message, 'error');
                btn.textContent = 'Add Transaction'; btn.disabled = false;
            } else {
                showToast('Transaction added!', 'success');
                document.getElementById('t-amount').value = '';
                document.getElementById('t-note').value = '';
                btn.textContent = 'Add Transaction'; btn.disabled = false;
                loadData(); // Reload to update math
            }
        });

        // Close Loan
        document.getElementById('close-loan-btn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to CLOSE this loan? This action cannot be undone.')) return;
            
            const btn = document.getElementById('close-loan-btn');
            btn.textContent = 'Closing...'; btn.disabled = true;

            const todayStr = new Date().toISOString().split('T')[0];
            const { error } = await sbClient.from('loans')
                .update({ status: 'Closed', closed_date: todayStr })
                .eq('id', loanId);

            if (error) {
                showToast(error.message, 'error');
                btn.textContent = 'Close This Loan'; btn.disabled = false;
            } else {
                showToast('Loan Closed Successfully', 'success');
                loadData(); // Reload UI
            }
        });

        // Init
        document.getElementById('t-date').value = new Date().toISOString().split('T')[0];
        document.addEventListener('DOMContentLoaded', loadData);

    </script>
</body>
</html>
