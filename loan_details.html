<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Ledger</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <script src="utils.js"></script>

    <style>
        /* Status Badge */
        .loan-status-badge {
            display: inline-block; padding: 0.4rem 1rem; font-weight: 600;
            border-radius: 20px; font-size: 0.9rem; color: white;
            margin-bottom: 1rem; text-align: center;
        }
        .status-Active { background-color: var(--success-color); }
        .status-Closed { background-color: var(--text-light); }

        /* Grids */
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; }
        .outstanding-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: center; }
        .outstanding-item { background: var(--bg-color); padding: 1rem; border-radius: 8px; }
        
        .total-due {
            margin-top: 1rem; text-align: center; background: var(--secondary-color);
            color: white; padding: 1.5rem; border-radius: 8px;
        }
        .total-due span { display: block; font-size: 2.2rem; font-weight: 700; }

        .table-wrapper { overflow-x: auto; margin-top: 1rem; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th, td { padding: 10px; border-bottom: 1px solid var(--border-color); text-align: left; }
        
        .loan-closed-overlay { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>

    <main class="container">
        <h1>Loan Ledger</h1>
        <div style="text-align: center;">
            <div id="status-badge" class="loan-status-badge">Loading...</div>
        </div>

        <section class="card">
            <h2>Loan Summary</h2>
            <div class="summary-grid">
                <div><strong>Customer:</strong> <span id="s-name">...</span></div>
                <div><strong>Phone:</strong> <span id="s-phone">...</span></div>
                <div><strong>Principal:</strong> <span id="s-principal">...</span></div>
                <div><strong>Rate:</strong> <span id="s-rate">...</span></div>
                <div><strong>Start Date:</strong> <span id="s-date">...</span></div>
                <div><strong>Articles:</strong> <span id="s-articles">...</span></div>
                <div><strong>Gross Wt:</strong> <span id="s-gross">...</span></div>
                <div><strong>Net Wt:</strong> <span id="s-net">...</span></div>
            </div>
        </section>

        <section class="card">
            <h2>Outstanding Balance</h2>
            <div class="outstanding-grid">
                <div class="outstanding-item">
                    <strong>Principal</strong>
                    <span id="out-prin" style="color: var(--primary-color);">...</span>
                </div>
                <div class="outstanding-item">
                    <strong>Interest</strong>
                    <span id="out-int" style="color: var(--secondary-color);">...</span>
                </div>
            </div>
            <div class="total-due">
                <strong>Total Amount Due</strong>
                <span id="out-total">...</span>
            </div>
        </section>

        <section class="card">
            <h2>Interest Breakdown (Monthly)</h2>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Due Date</th>
                            <th style="text-align:right">Principal</th>
                            <th style="text-align:right">Interest</th>
                        </tr>
                    </thead>
                    <tbody id="breakdown-body"></tbody>
                </table>
            </div>
        </section>

        <section class="card" id="add-txn-card">
            <h2>Add Transaction</h2>
            <form id="txn-form">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="t-date" required>
                </div>
                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" id="t-amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="t-type">
                        <option>Interest Payment</option>
                        <option>Principal Repayment</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <input type="text" id="t-note">
                </div>
                <button type="submit" class="btn-primary" id="add-btn">Add Transaction</button>
            </form>
        </section>

        <section class="card">
            <h2>Transaction History</h2>
            <div id="txn-history-list"></div>
        </section>

        <section class="card" id="action-card">
            <h2>Actions</h2>
            <button id="close-loan-btn" class="btn-danger">Close This Loan</button>
        </section>

    </main>

    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg> Dashboard</a>
        <a href="loan_list.html" class="nav-item active"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg> Loans</a>
        <a href="customer_list.html" class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg> Customers</a>
        <a href="pj.html" class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg> PJ List</a>
    </nav>
    <div id="toast-container"></div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const loanId = params.get('id') || params.get('loan_id'); // Handle both
        let g_loan = null;

        async function loadData() {
            if (!loanId) return;

            // Fetch Loan & Transactions
            const [lRes, tRes] = await Promise.all([
                sbClient.from('loans').select('*, customers(*)').eq('id', loanId).single(),
                sbClient.from('loan_transactions').select('*').eq('loan_id', loanId).order('txn_date', { ascending: true })
            ]);

            if (lRes.error) { showToast(lRes.error.message, 'error'); return; }

            g_loan = lRes.data;
            const transactions = tRes.data || [];

            // 1. Render Header
            document.getElementById('s-name').textContent = g_loan.customers?.name;
            document.getElementById('s-phone').textContent = g_loan.customers?.phone;
            document.getElementById('s-principal').textContent = currencyFormatter.format(g_loan.principal_amount);
            document.getElementById('s-rate').textContent = g_loan.interest_rate + '%';
            document.getElementById('s-date').textContent = dateFormatter(g_loan.start_date);
            document.getElementById('s-articles').textContent = g_loan.articles || '-';
            document.getElementById('s-gross').textContent = g_loan.gross || '-';
            document.getElementById('s-net').textContent = g_loan.net || '-';

            // 2. Calculate using UTILS (Shared Logic)
            // This function now returns the breakdown array too!
            const calc = calculateLoanOutstanding(g_loan, transactions);
            
            document.getElementById('out-prin').textContent = currencyFormatter.format(calc.principal);
            document.getElementById('out-int').textContent = currencyFormatter.format(calc.interest);
            document.getElementById('out-total').textContent = currencyFormatter.format(calc.total);

            // 3. Render Breakdown Table
            const tbody = document.getElementById('breakdown-body');
            if(calc.breakdown.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">No interest accrued yet (Wait for 1 month).</td></tr>';
            } else {
                tbody.innerHTML = calc.breakdown.map(row => `
                    <tr>
                        <td>${row.date}</td>
                        <td style="text-align:right">${currencyFormatter.format(row.principal)}</td>
                        <td style="text-align:right; color:var(--success-color)">+${currencyFormatter.format(row.interest)}</td>
                    </tr>
                `).join('');
            }

            // 4. Render Transactions (Newest First)
            const histContainer = document.getElementById('txn-history-list');
            const displayTxns = [...transactions].sort((a,b) => new Date(b.txn_date) - new Date(a.txn_date));
            
            if(displayTxns.length === 0) histContainer.innerHTML = '<p style="text-align:center">No transactions.</p>';
            else {
                histContainer.innerHTML = displayTxns.map(t => `
                    <div class="list-item" style="cursor:default">
                        <div>
                            <div style="font-weight:600">${dateFormatter(t.txn_date)}</div>
                            <small>${t.txn_type} ${t.note ? '- '+t.note : ''}</small>
                        </div>
                        <div style="font-weight:700; color:${t.txn_type.includes('Int')?'var(--success-color)':'var(--secondary-color)'}">
                            -${currencyFormatter.format(t.amount)}
                        </div>
                    </div>
                `).join('');
            }

            // 5. Status
            const badge = document.getElementById('status-badge');
            badge.textContent = g_loan.status;
            badge.className = `loan-status-badge status-${g_loan.status}`;
            
            if(g_loan.status === 'Closed') {
                document.getElementById('add-txn-card').classList.add('loan-closed-overlay');
                document.getElementById('add-btn').disabled = true;
                document.getElementById('action-card').classList.add('loan-closed-overlay');
                document.getElementById('close-loan-btn').disabled = true;
            }
        }

        // Add Transaction
        document.getElementById('txn-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('add-btn');
            btn.textContent = 'Saving...'; btn.disabled = true;
            
            const { error } = await sbClient.from('loan_transactions').insert({
                loan_id: loanId,
                txn_date: document.getElementById('t-date').value,
                amount: document.getElementById('t-amount').value,
                txn_type: document.getElementById('t-type').value,
                note: document.getElementById('t-note').value
            });
            
            if(error) { showToast(error.message, 'error'); }
            else { 
                showToast('Added!', 'success'); 
                document.getElementById('t-amount').value = '';
                document.getElementById('t-note').value = '';
                loadData(); 
            }
            btn.textContent = 'Add Transaction'; btn.disabled = false;
        });

        // Close Loan
        document.getElementById('close-loan-btn').addEventListener('click', async () => {
            if(!confirm('Close this loan?')) return;
            const btn = document.getElementById('close-loan-btn');
            btn.textContent = 'Closing...';
            
            const { error } = await sbClient.from('loans')
                .update({ status: 'Closed', closed_date: new Date().toISOString().split('T')[0] })
                .eq('id', loanId);
                
            if(error) showToast(error.message, 'error');
            else { showToast('Loan Closed', 'success'); loadData(); }
        });

        document.getElementById('t-date').value = new Date().toISOString().split('T')[0];
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
