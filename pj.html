<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PJ List</title>
    
    <link rel="stylesheet" href="style.css">

    <style>
        /* Controls Grid */
        .controls-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
            background: var(--card-bg);
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        @media (min-width: 600px) {
            .controls-container {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        /* Responsive Table Wrapper */
        .table-wrapper {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px; 
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        th {
            background-color: #fafafa;
            font-size: 0.85rem;
            color: var(--text-light);
            text-transform: uppercase;
            font-weight: 600;
            white-space: nowrap;
        }

        td { font-size: 0.95rem; }

        .col-money { font-family: monospace; font-weight: 600; }
        .col-interest { color: var(--primary-color); }

        /* Status Dropdown Styling */
        .status-select {
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid transparent;
            cursor: pointer;
            appearance: none; /* Removes default arrow on some browsers for cleaner look */
            -webkit-appearance: none;
            text-align: center;
        }
        
        .status-select:focus { outline: none; box-shadow: 0 0 0 2px var(--primary-light); }

        .status-select.Active {
            background-color: #e8f5e9;
            color: var(--success-color);
            border-color: #c8e6c9;
        }
        
        .status-select.Closed {
            background-color: #f5f5f5;
            color: var(--text-light);
            border-color: #e0e0e0;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <script src="utils.js"></script>
</head>
<body>

    <main class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h1 style="margin: 0;">PJ List</h1>
            <div id="live-indicator" style="font-size: 0.8rem; color: var(--success-color); display: flex; align-items: center; gap: 5px; opacity: 0; transition: opacity 0.5s;">
                <span style="width: 8px; height: 8px; background: var(--success-color); border-radius: 50%;"></span>
                Live
            </div>
        </div>

        <section class="controls-container">
            <div class="form-group" style="margin-bottom:0;">
                <label for="search">Search ID</label>
                <input type="search" id="search" placeholder="e.g. 123">
            </div>
            <div class="form-group" style="margin-bottom:0;">
                <label for="filter-status">Filter Status</label>
                <select id="filter-status">
                    <option value="All">All Statuses</option>
                    <option value="Active">Active Only</option>
                    <option value="Closed">Closed Only</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom:0;">
                <label for="sort-by">Sort By</label>
                <select id="sort-by">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="amt-high">Amount (High → Low)</option>
                    <option value="amt-low">Amount (Low → High)</option>
                </select>
            </div>
        </section>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Months</th>
                        <th>Interest</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="pj-body">
                    <tr><td colspan="6" style="text-align:center; padding:20px; color:#888;">Loading records...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
            Dashboard
        </a>
        <a href="loan_list.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
            Loans
        </a>
        <a href="customer_list.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            Customers
        </a>
        <a href="pj.html" class="nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
            PJ List
        </a>
    </nav>
    <div id="toast-container"></div>

    <script>
        // --- CONFIG ---
        const PJ_ANNUAL_RATE = 0.156; // 15.6%
        const PJ_MONTHLY_RATE = PJ_ANNUAL_RATE / 12;

        let allPJ = []; // Master list

        const dom = {
            tbody: document.getElementById('pj-body'),
            liveIndicator: document.getElementById('live-indicator'),
            search: document.getElementById('search'),
            filter: document.getElementById('filter-status'),
            sort: document.getElementById('sort-by')
        };

        // --- 1. LOGIC ---

        function calculateInterestMonths(startDateStr) {
            const parts = startDateStr.split('-');
            const start = new Date(parts[0], parts[1] - 1, parts[2]);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (start > today) return 0;
            if (start.getTime() === today.getTime()) return 1;

            let years = today.getFullYear() - start.getFullYear();
            let months = today.getMonth() - start.getMonth();
            let days = today.getDate() - start.getDate();
            let totalMonths = years * 12 + months;

            if (days < 0) totalMonths--;

            const tempDate = new Date(start);
            tempDate.setMonth(tempDate.getMonth() + totalMonths);
            const diffTime = Math.abs(today - tempDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            if (totalMonths <= 0) return 1;
            if (diffDays < 15) return totalMonths + 0.5;
            else return totalMonths + 1;
        }

        // --- 2. DATA LOADING & RENDERING ---

        async function loadPJ(isUpdate = false) {
            try {
                const { data, error } = await sbClient
                    .from('pj')
                    .select('*')
                    .order('date', { ascending: false });

                if (error) throw error;
                
                allPJ = data || [];
                renderList();

                if (isUpdate) {
                    dom.liveIndicator.style.opacity = '1';
                    setTimeout(() => { dom.liveIndicator.style.opacity = '0'; }, 2000);
                }
            } catch (err) {
                console.error(err);
                if(!isUpdate) dom.tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Error loading data.</td></tr>';
            }
        }

        function renderList() {
            const term = dom.search.value.toLowerCase();
            const statusVal = dom.filter.value;
            const sortVal = dom.sort.value;

            // 1. Filter
            let processed = allPJ.filter(item => {
                const idMatch = String(item.pj_id).includes(term);
                const statusMatch = statusVal === 'All' || item.status === statusVal;
                return idMatch && statusMatch;
            });

            // 2. Sort
            processed.sort((a, b) => {
                if (sortVal === 'newest') return new Date(b.date) - new Date(a.date);
                if (sortVal === 'oldest') return new Date(a.date) - new Date(b.date);
                if (sortVal === 'amt-high') return parseFloat(b.amount) - parseFloat(a.amount);
                if (sortVal === 'amt-low') return parseFloat(a.amount) - parseFloat(b.amount);
                return 0;
            });

            // 3. Render
            if (processed.length === 0) {
                dom.tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No matching records.</td></tr>';
                return;
            }

            dom.tbody.innerHTML = processed.map(item => {
                const principal = parseFloat(item.amount);
                let interest = 0;
                let months = 0;
                
                // Only calculate interest if active
                if (item.status === 'Active') {
                    months = calculateInterestMonths(item.date);
                    interest = principal * PJ_MONTHLY_RATE * months;
                }

                return `
                <tr>
                    <td>#${item.pj_id}</td>
                    <td>${dateFormatter(item.date)}</td>
                    <td class="col-money">${currencyFormatter.format(principal)}</td>
                    <td>${item.status === 'Active' ? months : '-'}</td>
                    <td class="col-money col-interest">${item.status === 'Active' ? currencyFormatter.format(interest) : '-'}</td>
                    <td>
                        <select 
                            class="status-select ${item.status}" 
                            onchange="updateStatus(${item.pj_id}, this.value)"
                        >
                            <option value="Active" ${item.status === 'Active' ? 'selected' : ''}>Active</option>
                            <option value="Closed" ${item.status === 'Closed' ? 'selected' : ''}>Closed</option>
                        </select>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- 3. ACTIONS ---

        // Exposed global function for the onchange event
        window.updateStatus = async (id, newStatus) => {
            const confirmMsg = `Are you sure you want to mark PJ #${id} as ${newStatus}?`;
            if(!confirm(confirmMsg)) {
                // Revert selection if canceled (simple reload easier)
                renderList(); 
                return;
            }

            try {
                const { error } = await sbClient
                    .from('pj')
                    .update({ status: newStatus })
                    .eq('pj_id', id);

                if (error) throw error;
                
                showToast(`PJ #${id} marked as ${newStatus}`);
                // Realtime listener will auto-refresh, but we can update locally for speed
                const idx = allPJ.findIndex(p => p.pj_id === id);
                if(idx !== -1) allPJ[idx].status = newStatus;
                renderList();

            } catch (err) {
                showToast(err.message, 'error');
                renderList(); // Revert UI on error
            }
        }

        function setupRealtime() {
            sbClient.channel('pj-list-updates')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'pj' }, 
                () => loadPJ(true))
                .subscribe();
        }

        // --- 4. INIT ---
        dom.search.addEventListener('input', renderList);
        dom.filter.addEventListener('change', renderList);
        dom.sort.addEventListener('change', renderList);

        document.addEventListener('DOMContentLoaded', () => {
            loadPJ();
            setupRealtime();
        });

    </script>
</body>
</html>
