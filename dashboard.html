<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <script src="utils.js"></script>
</head>
<body>
    <main class="container">
        <h1>Dashboard</h1>
        <a href="new_loan.html" class="btn-primary" style="display:block; text-align:center; text-decoration:none; margin-bottom:20px;">+ New Loan</a>

        <div class="card" style="background: var(--primary-color); color: white; text-align: center;">
            <h3 style="opacity:0.9;">Total Outstanding</h3>
            <p id="grand-total" style="font-size:2.5rem; font-weight:700;">Loading...</p>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div class="card">
                <h3>Principal</h3>
                <p id="total-principal" style="color:var(--primary-color); font-size:1.2rem; font-weight:bold;">...</p>
            </div>
            <div class="card">
                <h3>Interest</h3>
                <p id="total-interest" style="color:var(--success-color); font-size:1.2rem; font-weight:bold;">...</p>
            </div>
        </div>

        <h2>Overview</h2>
        <div class="card">
            <p><strong>Active Loans:</strong> <span id="count-loans">...</span></p>
            <p><strong>Total Customers:</strong> <span id="count-customers">...</span></p>
            <p><strong>PJ Items:</strong> <span id="count-pj">...</span></p>
        </div>
    </main>

    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
            Dashboard
        </a>
        <a href="loan_list.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
            Loans
        </a>
        <a href="customer_list.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            Customers
        </a>
        <a href="pj.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
            PJ List
        </a>
    </nav>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Fetch Active Data
            const [loans, txns, customers, pj] = await Promise.all([
                sbClient.from('loans').select('*').eq('status', 'Active'),
                sbClient.from('loan_transactions').select('*'), // Fetch all, we filter in JS
                sbClient.from('customers').select('id', { count: 'exact', head: true }),
                sbClient.from('pj').select('pj_id', { count: 'exact', head: true }).eq('status', 'Active')
            ]);

            // 2. Calculate Totals using shared Logic
            let sumPrincipal = 0;
            let sumInterest = 0;

            if (loans.data) {
                loans.data.forEach(loan => {
                    // Uses the function from utils.js
                    const result = calculateLoanOutstanding(loan, txns.data || []);
                    sumPrincipal += result.principal;
                    sumInterest += result.interest;
                });
            }

            // 3. Render
            document.getElementById('grand-total').textContent = currencyFormatter.format(sumPrincipal + sumInterest);
            document.getElementById('total-principal').textContent = currencyFormatter.format(sumPrincipal);
            document.getElementById('total-interest').textContent = currencyFormatter.format(sumInterest);
            document.getElementById('count-loans').textContent = loans.data ? loans.data.length : 0;
            document.getElementById('count-customers').textContent = customers.count;
            document.getElementById('count-pj').textContent = pj.count;
        });
    </script>
</body>
</html>
